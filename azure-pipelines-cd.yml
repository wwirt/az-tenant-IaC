# Azure DevOps CD Pipeline for Azure Tenant Vending Platform
trigger: none

resources:
  pipelines:
    - pipeline: ciPipeline
      source: azure-pipelines-ci
      trigger:
        branches:
          include:
            - main

variables:
  terraformVersion: '1.5.0'
  backendServiceConnection: 'terraform-backend-connection'
  tenantServiceConnection: 'tenant-management-connection'
  backendResourceGroup: 'terraform-state-rg'
  backendStorageAccount: 'terraformstatestore001'
  workingDirectory: '$(System.DefaultWorkingDirectory)/terraform'
  configDirectory: '$(System.DefaultWorkingDirectory)/config'

stages:
- stage: Deploy_Dev
  displayName: 'Deploy to Development'
  condition: and(succeeded(), eq(variables['Build.SourceBranch'], 'refs/heads/main'))
  jobs:
  - template: templates/deployment-job-template.yml
    parameters:
      environment: 'development'
      displayName: 'Deploy Development Environment'
      terraformStateKey: 'tenant-dev.tfstate'
      environmentShort: 'dev'

- stage: Deploy_Prod
  displayName: 'Deploy to Production'
  dependsOn: Deploy_Dev
  jobs:
  - template: templates/deployment-job-template.yml
    parameters:
      environment: 'production'
      displayName: 'Deploy Production Environment'
      terraformStateKey: 'tenant-prod.tfstate'
      environmentShort: 'prod'
